using System;
using System.IO;
using System.Linq;
using System.Xml.Linq;

namespace WhatsAppSimHubPlugin.Core
{
    /// <summary>
    /// Merge de dashboards usando t√©cnica V2.0 - Wrapper com 2 Layers
    /// Dashboard 1 (base) + Dashboard 2 (WhatsApp overlay) = Dashboard Merged
    /// </summary>
    public class DashboardMerger
    {
        private const string MERGED_DASHBOARD_NAME = "WhatsApp_merged_overlay_dash";
        private readonly Action<string> _log;
        private readonly string _dashTemplatesPath;

        public DashboardMerger(string dashTemplatesPath, Action<string> log = null)
        {
            _dashTemplatesPath = dashTemplatesPath;
            _log = log;
        }

        /// <summary>
        /// Verifica se um dashboard existe em DashTemplates
        /// </summary>
        public bool DashboardExists(string dashboardName)
        {
            if (string.IsNullOrEmpty(dashboardName)) return false;

            string dashPath = Path.Combine(_dashTemplatesPath, dashboardName);
            return Directory.Exists(dashPath);
        }

        /// <summary>
        /// Faz merge de 2 dashboards usando t√©cnica V2.0 (Wrapper com 2 Layers)
        /// </summary>
        /// <param name="baseDashboardName">Dashboard base (Layer 1)</param>
        /// <param name="overlayDashboardName">Dashboard overlay - WhatsApp (Layer 2)</param>
        /// <returns>Nome do dashboard merged criado ou null se falhou</returns>
        public string MergeDashboards(string baseDashboardName, string overlayDashboardName)
        {
            try
            {
                _log?.Invoke($"üîÑ Starting dashboard merge: {baseDashboardName} + {overlayDashboardName}");

                // Validar que ambos existem
                if (!DashboardExists(baseDashboardName))
                {
                    _log?.Invoke($"‚ùå Base dashboard not found: {baseDashboardName}");
                    return null;
                }

                if (!DashboardExists(overlayDashboardName))
                {
                    _log?.Invoke($"‚ùå Overlay dashboard not found: {overlayDashboardName}");
                    return null;
                }

                // Carregar ambos dashboards
                var baseDash = LoadDashboard(baseDashboardName);
                var overlayDash = LoadDashboard(overlayDashboardName);

                if (baseDash == null || overlayDash == null)
                {
                    _log?.Invoke("‚ùå Failed to load dashboards");
                    return null;
                }

                // Criar dashboard wrapper
                var mergedDash = CreateWrapperDashboard(baseDash, overlayDash, baseDashboardName, overlayDashboardName);

                if (mergedDash == null)
                {
                    _log?.Invoke("‚ùå Failed to create wrapper dashboard");
                    return null;
                }

                // Guardar dashboard merged
                bool saved = SaveMergedDashboard(mergedDash, MERGED_DASHBOARD_NAME);

                if (!saved)
                {
                    _log?.Invoke("‚ùå Failed to save merged dashboard");
                    return null;
                }

                // Copiar recursos de ambos dashboards
                CopyDashboardResources(baseDashboardName, MERGED_DASHBOARD_NAME);
                CopyDashboardResources(overlayDashboardName, MERGED_DASHBOARD_NAME);

                _log?.Invoke($"‚úÖ Dashboard merge completed: {MERGED_DASHBOARD_NAME}");
                return MERGED_DASHBOARD_NAME;
            }
            catch (Exception ex)
            {
                _log?.Invoke($"‚ùå MergeDashboards error: {ex.Message}");
                return null;
            }
        }

        /// <summary>
        /// Carrega um dashboard (ficheiro config.xml)
        /// </summary>
        private XDocument LoadDashboard(string dashboardName)
        {
            try
            {
                string configPath = Path.Combine(_dashTemplatesPath, dashboardName, "config.xml");

                if (!File.Exists(configPath))
                {
                    _log?.Invoke($"‚ùå config.xml not found: {configPath}");
                    return null;
                }

                return XDocument.Load(configPath);
            }
            catch (Exception ex)
            {
                _log?.Invoke($"‚ùå LoadDashboard error ({dashboardName}): {ex.Message}");
                return null;
            }
        }

        /// <summary>
        /// Cria dashboard wrapper com 2 layers (V2.0)
        /// </summary>
        private XDocument CreateWrapperDashboard(XDocument baseDash, XDocument overlayDash,
            string baseDashName, string overlayDashName)
        {
            try
            {
                // Obter dimens√µes do dashboard base
                var baseRoot = baseDash.Root;
                int width = int.Parse(baseRoot.Attribute("Width")?.Value ?? "800");
                int height = int.Parse(baseRoot.Attribute("Height")?.Value ?? "480");

                // Criar novo dashboard wrapper
                var wrapper = new XDocument(
                    new XElement("DashboardPlugin",
                        new XAttribute("Width", width),
                        new XAttribute("Height", height),
                        new XAttribute("Name", MERGED_DASHBOARD_NAME),
                        new XElement("Screens",
                            new XElement("Screen",
                                new XAttribute("Name", "MainScreen"),
                                new XElement("Items",
                                    // Layer 1: Base Dashboard (sempre vis√≠vel)
                                    CreateLayerItem(baseDashName, width, height, isOverlay: false),

                                    // Layer 2: WhatsApp Overlay (condicional - s√≥ quando h√° mensagem)
                                    CreateLayerItem(overlayDashName, width, height, isOverlay: true)
                                )
                            )
                        )
                    )
                );

                return wrapper;
            }
            catch (Exception ex)
            {
                _log?.Invoke($"‚ùå CreateWrapperDashboard error: {ex.Message}");
                return null;
            }
        }

        /// <summary>
        /// Cria um Layer item (Dashboard reference)
        /// </summary>
        private XElement CreateLayerItem(string dashboardName, int width, int height, bool isOverlay)
        {
            var layer = new XElement("Item",
                new XAttribute("Type", "DashboardReference"),
                new XAttribute("Name", isOverlay ? "WhatsAppOverlayLayer" : "BaseDashboardLayer"),
                new XAttribute("X", 0),
                new XAttribute("Y", 0),
                new XAttribute("Width", width),
                new XAttribute("Height", height),
                new XAttribute("ReferencedDashboard", dashboardName)
            );

            // Se for overlay, adicionar binding condicional
            if (isOverlay)
            {
                layer.Add(new XAttribute("VisibilityProperty", "[WhatsApp.HasMessage]"));
            }

            return layer;
        }

        /// <summary>
        /// Guarda dashboard merged
        /// </summary>
        private bool SaveMergedDashboard(XDocument dashboard, string dashboardName)
        {
            try
            {
                // Criar pasta do dashboard
                string dashPath = Path.Combine(_dashTemplatesPath, dashboardName);

                if (Directory.Exists(dashPath))
                {
                    _log?.Invoke($"üóëÔ∏è Removing old merged dashboard: {dashPath}");
                    Directory.Delete(dashPath, true);
                }

                Directory.CreateDirectory(dashPath);

                // Guardar config.xml
                string configPath = Path.Combine(dashPath, "config.xml");
                dashboard.Save(configPath);

                _log?.Invoke($"‚úÖ Saved merged dashboard: {configPath}");
                return true;
            }
            catch (Exception ex)
            {
                _log?.Invoke($"‚ùå SaveMergedDashboard error: {ex.Message}");
                return false;
            }
        }

        /// <summary>
        /// Copia recursos de um dashboard para outro (imagens, fontes, etc)
        /// </summary>
        private void CopyDashboardResources(string sourceDashName, string targetDashName)
        {
            try
            {
                string sourcePath = Path.Combine(_dashTemplatesPath, sourceDashName);
                string targetPath = Path.Combine(_dashTemplatesPath, targetDashName);

                if (!Directory.Exists(sourcePath)) return;
                if (!Directory.Exists(targetPath)) return;

                // Copiar todos os ficheiros exceto config.xml
                foreach (var file in Directory.GetFiles(sourcePath))
                {
                    string fileName = Path.GetFileName(file);

                    // Ignorar config.xml
                    if (fileName.Equals("config.xml", StringComparison.OrdinalIgnoreCase))
                        continue;

                    string targetFile = Path.Combine(targetPath, fileName);

                    // N√£o sobrescrever se j√° existe
                    if (!File.Exists(targetFile))
                    {
                        File.Copy(file, targetFile);
                    }
                }

                // Copiar subpastas (ex: fonts/, images/)
                foreach (var dir in Directory.GetDirectories(sourcePath))
                {
                    string dirName = Path.GetFileName(dir);
                    string targetDir = Path.Combine(targetPath, dirName);

                    if (!Directory.Exists(targetDir))
                    {
                        CopyDirectory(dir, targetDir);
                    }
                }
            }
            catch (Exception ex)
            {
                _log?.Invoke($"‚ö†Ô∏è CopyDashboardResources warning ({sourceDashName}): {ex.Message}");
            }
        }

        /// <summary>
        /// Copia diret√≥rio recursivamente
        /// </summary>
        private void CopyDirectory(string sourceDir, string targetDir)
        {
            Directory.CreateDirectory(targetDir);

            foreach (var file in Directory.GetFiles(sourceDir))
            {
                string fileName = Path.GetFileName(file);
                string targetFile = Path.Combine(targetDir, fileName);
                File.Copy(file, targetFile, overwrite: false);
            }

            foreach (var dir in Directory.GetDirectories(sourceDir))
            {
                string dirName = Path.GetFileName(dir);
                string targetSubDir = Path.Combine(targetDir, dirName);
                CopyDirectory(dir, targetSubDir);
            }
        }

        /// <summary>
        /// Nome do dashboard merged
        /// </summary>
        public static string MergedDashboardName => MERGED_DASHBOARD_NAME;
    }
}
